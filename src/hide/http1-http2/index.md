---
title: HTTP、HTTP2与HTTPs
date: "2018-06-27T21:46:37.121Z"
tags: ["HTTP", "HTTP2", "HTTPs"]
---

todo
- 多路复用在哪层
- 规范细则。


## HTTP2
在UI上，没有任何元素标明你正在使用http2。但想确认也并不复杂，一种方法是启用“Web developer->Network”，再查看响应头里面服务器发回来的内容。这个响应是“HTTP/2.0”
#### 前身SPDY。

SPDY因为背负了“它是Google的协议”这个恶名，导致它的发展总是畏首畏脚。
Chrome6开始支持SPDY，而后用HTTP/2取代SPDY。
在地址栏里进入chrome://flags/#enable-spdy4 ，如果没有被enable的话，点击"enable"启用。
TLS-only。Chrome只在TLS上实现了http2。你只会在以 https:// 做前缀的网站里得到http2的支持。
建立在SPDY的基本范式之上的http2会被更广泛的部署，毕竟它是一个IETF制定的协议。

#### 新特性
- 多路复用。
    - 在同一连接中来自各个流的数据包会被混合在一起，最终会在终点站分开，消除了同域名并发连接数限制。
    - 和快速丢弃不需要的流一起，避免了head of line blocking(线头阻塞)的困扰。
- HTTP/2头部压缩。
- 流的优先级。合理利用流的优先级，可以让客户端尽可能优先收到更重要的数据。
- 重置-后悔药。
    - HTTP 1.1中，一个含有确切Content-Length的HTTP消息被送出之后，就很难中断它了。在http2里面，我们可以通过发送RST_STREAM帧来“终止当前传输的消息，并重新发送一个新消息”。
    - 服务端开始Push数据与收到RST_STREAM帧这二者是竞争状态。如果服务端正在Push数据时收到了RST_STREAM帧，它会停止发送剩余数据。
- 服务器推送（Server push）/ 缓存推送。
    - 当一个客户端请求资源X，而服务器知道它很可能也需要资源Z的情况下，服务器可以在客户端发送请求前，主动将重要资源Z推送给客户端。这个功能帮助客户端将Z放进缓存以备将来之需。
    - 而若服务端要推送的资源浏览器已经缓存过，客户端可以通过发送一个RST_STREAM帧来中止该推送的流，服务端收到这个信号之前所传输的数据就造成了带宽浪费。可以在服务端记录给每个客户端发送过何种资源，何时过期来优化。
- 流量控制。
    - 每个HTTP2流都有自己的公示的流量窗口，用以限制另一端发送数据。比如，客户端除能限制服务端Push流的最大数目外，还可限制在第一个往返内发送的数据大小。
    - 只有数据帧会受到流量控制。

#### 扩展
类似“番外”，不属于协议本身。在draft-12之后，HTTP2落定确定了允许添加扩展。
    - 备选服务（Alternative Services）。
        - 出于性能考虑，or 服务器维护等。
        - 服务器通过发送Alt-Svc头（或者http2的ALTSVC帧）来告知客户端选择另一个备选服务（即不同的服务源、主机或端口，但却能获取同样内容的路由）。客户端应该尝试异步的去连接到该服务，如果连接成功的话，即可以使用该备选服务。
    - 机会型TLS（Opportunistic TLS）。
        - Alt-Svc头部意味着允许服务器基于 http:// 提供内容，与此同时，这个头部也意味着告知客户端：同样的内容也可以通过TLS连接来获取。
        - 连接会产生一个未认证的、在任何地方也不会被标示为“安全”的TLS连接，也不会在客户端界面上出现任何锁标识，所以没法让用户知道这其实不是常规的HTTP连接。因此受到很多人强烈反对。
    - 阻塞（Blocked）。
        - 当服务端存在需要发送的内容，但流控制却禁止发送任何数据时，那么此类型的帧将会被发送且仅发送一次。
        - 设计目的在于，如果你接收到了此帧，那么连接中必然有错误发生或者是得到了低于期望的传输速度。
        - 属实验特性，如果它无法获得良好的反馈，那么该特性最后会被移除。

#### 问题
- 兼容HTTP/1.1的范式是HTTP2的目标之一，所以一些老的HTTP功能仍然被保留，如一些常用的协议头、可怕的cookies、验证头等等。对于网站的开发者而言，在短期内开发和部署同一套前端来支持HTTP 1.1和http2的客户端访问并获得最大性能将会是一个挑战。
- “TLS让速度变得更慢”，TLS会消耗更多的CPU和其他资源。不过HTTP2可以在单一连接上提供多路复用的流。

#### 如何判断网站启用了HTTP2
打开网页后，在console控制台输入：`window.chrome.loadTimes()`，看connectionInfo的值为“http/1.1” or “h2”啥的。也可以直接输入：`window.chrome.loadTimes().connectionInfo`。

## 参考资料
- [http2讲解](https://ye11ow.gitbooks.io/http2-explained/content)
- [HTTP/2 中的 Server Push 讨论](https://imququ.com/post/server-push-in-http2.html)
